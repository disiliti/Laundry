<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Print Nota/Label</title>
  <link rel="stylesheet" href="quickwins.css">
  <script src="libs/qrcode.min.js"></script>
  <script>
    function dec(h){
      const p = h.replace(/^#/, '').split('&')[0];
      try { return JSON.parse(decodeURIComponent(escape(atob(p)))); } catch(e){ return {}; }
    }
    function getType(h){
      const m = h.split('&').find(x=>x.startsWith('type='));
      return (m||'').split('=')[1]||'receipt';
    }
    function money(n){ return (n||0).toLocaleString('id-ID'); }
    document.addEventListener('DOMContentLoaded', ()=>{
      const data = dec(location.hash);
      const type = getType(location.hash);
      const brand = (window.opener && window.opener.QW_CONFIG?.print?.brand) || {name:'Laundry', address:'Alamat', phone:'62xxx'};
      if(type==='label'){
        document.body.innerHTML = `<div class="label">
          <div class="meta">
            <div><strong>${data.id||'-'}</strong></div>
            <div>${(data.customer&&data.customer.name)||''}</div>
            <div style="font-size:10px">${new Date().toLocaleString('id-ID')}</div>
          </div>
          <div id="qrcode"></div>
        </div>`;
      }else{ // receipt
        const recClass = (window.opener && window.opener.QW_CONFIG?.print?.receiptWidth==='80mm') ? 'receipt w80' : 'receipt';
        document.body.classList.add('receipt');
        document.body.innerHTML = `
          <div class="${recClass} small">
            <div class="center"><strong>${brand.name}</strong></div>
            <div class="center">${brand.address}</div>
            <div class="center">WA: ${brand.phone}</div>
            <div class="divider"></div>
            <div>ID: ${data.id||'-'}</div>
            <div>Nama: ${(data.customer&&data.customer.name)||''}</div>
            <div>Total: Rp${money(data.total||0)}</div>
            <div>Status: ${data.status||'Diterima'}</div>
            <div class="divider"></div>
            <div class="qr"><div id="qrcode"></div></div>
            <div class="center">Terima kasih üôè</div>
          </div>`;
      }
      const url = (window.opener && data.id && window.opener.QW && window.opener.QW.updateStatus) ?
        window.opener.QW.updateStatus(data.id, data.status||'Diterima') : null;
      const target = document.getElementById('qrcode');
      if(target){
        new QRCode(target, {text: (data.statusUrl || url || location.href), width: 96, height: 96});
      }
      setTimeout(()=> window.print(), 250);
    });
  </script>
</head>
<body></body>
</html>
