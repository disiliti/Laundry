/*! XLSX Mini Shim: only json_to_sheet & writeFile via CSV fallback (MIT) */
window.XLSX = window.XLSX || {};
(function(){
  function json_to_sheet(rows){
    if(!rows||!rows.length) return {aoa:[[]]};
    const headers = Object.keys(rows[0]);
    const aoa = [headers].concat(rows.map(r=>headers.map(h=>r[h])));
    return {aoa, headers};
  }
  function writeFile(wb, filename){
    const ws = wb.Sheets[wb.SheetNames[0]];
    const lines = ws.aoa.map(r=>r.map(v=>{
      const s = (v==null?'':String(v));
      return /[,"\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s;
    }).join(",")).join("\n");
    const blob = new Blob([lines], {type: "text/csv"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename.replace(/\.xlsx$/i, ".csv");
    a.click();
  }
  function book_new(){ return {SheetNames:[], Sheets:{}}; }
  function book_append_sheet(wb, ws, name){ wb.SheetNames.push(name); wb.Sheets[name]=ws; }
  window.XLSX.utils = { json_to_sheet };
  window.XLSX.writeFile = writeFile;
  window.XLSX.utils.book_new = book_new;
  window.XLSX.utils.book_append_sheet = book_append_sheet;
})();
